<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>LukitaPort ‚Äî Port Scanner</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
a,button{-webkit-tap-highlight-color:transparent}

:root{
    --bg:#050505; --card:#0f0f0f;
    --text:#f0f0f0; --muted:#999; --dim:#444;
    --accent:#ff0033; --adim:rgba(255,0,51,.1); --aglow:rgba(255,0,51,.3);
    --border:#222; --bm:#333;
    --green:#00ff88; --gdim:rgba(0,255,136,.08);
    --red:#ff4444; --rdim:rgba(255,68,68,.08);
    --yellow:#ffaa00; --ydim:rgba(255,170,0,.08);
    --mono:'Fira Code',monospace;
    --sans:'Inter',sans-serif;
}

html{scrollbar-width:thin;scrollbar-color:#333 #050505}
body{background:var(--bg);color:var(--text);font-family:var(--sans);font-size:14px;line-height:1.6;min-height:100vh}
body.es .en{display:none!important}
body.en .es{display:none!important}

::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:#333;border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--accent)}

/* ‚îÄ‚îÄ POPUP LEGAL ‚îÄ‚îÄ */
#legal-overlay{position:fixed;inset:0;background:rgba(5,5,5,.92);backdrop-filter:blur(6px);z-index:9000;display:flex;align-items:center;justify-content:center;padding:24px;animation:fadeO .3s ease}
#legal-overlay.hidden{display:none}
@keyframes fadeO{from{opacity:0}to{opacity:1}}
.legal-popup{background:var(--card);border:1px solid var(--accent);border-radius:4px;max-width:520px;width:100%;padding:32px;box-shadow:0 0 40px rgba(255,0,51,.15);animation:popIn .3s ease}
@keyframes popIn{from{opacity:0;transform:translateY(-12px)}to{opacity:1;transform:translateY(0)}}
.legal-popup-title{font-family:var(--mono);font-size:13px;font-weight:bold;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent);margin-bottom:16px}
.legal-popup p{color:var(--muted);font-size:13px;line-height:1.7;margin-bottom:10px}
.legal-popup p:last-of-type{margin-bottom:0}
.legal-popup p strong{color:var(--text)}
.legal-popup-actions{margin-top:24px;display:flex;justify-content:flex-end}
.btn-accept{padding:10px 28px;background:transparent;border:1px solid var(--accent);color:var(--accent);font-family:var(--mono);font-size:12px;letter-spacing:1.5px;text-transform:uppercase;border-radius:4px;transition:all .2s;position:relative;overflow:hidden}
.btn-accept::before{content:'';position:absolute;inset:0;background:var(--accent);transform:scaleX(0);transform-origin:left;transition:transform .25s ease;z-index:-1}
.btn-accept:hover::before{transform:scaleX(1)}
.btn-accept:hover{color:#fff}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header{position:fixed;top:0;width:100%;z-index:1000;display:flex;align-items:center;justify-content:flex-end;padding:14px 5%;background:rgba(5,5,5,.95);backdrop-filter:blur(5px);border-bottom:1px solid var(--border)}
.lang-switch{color:var(--muted);font-size:.9rem;display:flex;align-items:center;gap:7px;font-family:var(--mono);border:1px solid var(--bm);padding:7px 14px;border-radius:4px;transition:all .3s;background:transparent}
.lang-switch:hover{color:var(--accent);border-color:var(--accent);background:var(--adim)}
.lang-switch.pulse{animation:sp 2s ease-out}
@keyframes sp{0%,15%{border-color:var(--accent);color:var(--accent);background:var(--adim)}100%{border-color:var(--bm);color:var(--muted);background:transparent}}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
main{max-width:960px;margin:0 auto;padding:100px 5% 60px}
.page-title{text-align:center;margin-bottom:36px}
.page-title h1{font-family:var(--sans);font-size:2.2rem;font-weight:700;color:var(--text);letter-spacing:-.5px;margin-bottom:6px}
.page-title h1 span{color:var(--accent)}
.page-title p{font-family:var(--mono);font-size:11px;color:var(--muted);letter-spacing:1px}

/* ‚îÄ‚îÄ PANEL ‚îÄ‚îÄ */
.panel{background:var(--card);border:1px solid var(--border);border-radius:4px;margin-bottom:20px;overflow:hidden}
.panel-header{display:flex;align-items:center;gap:10px;padding:12px 20px;border-bottom:1px solid var(--border);font-family:var(--mono);font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted)}
.dot{display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--accent);box-shadow:0 0 6px var(--aglow);flex-shrink:0}
.panel-body{padding:24px}

/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.form-group{display:flex;flex-direction:column;gap:7px}
.form-group.full-width{grid-column:1/-1}
label{font-family:var(--mono);font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim)}
input[type="text"],input[type="number"],select{background:#111;border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:var(--mono);font-size:13px;padding:10px 14px;outline:none;transition:border-color .2s,box-shadow .2s;width:100%}
input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 2px var(--adim)}
select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' fill='none'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23666' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px}
.custom-range{display:none;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px}
.custom-range.visible{display:grid}
.slider-row{display:flex;align-items:center;gap:12px}
input[type="range"]{flex:1;-webkit-appearance:none;height:2px;background:var(--border);border-radius:2px;outline:none}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;border-radius:50%;background:var(--accent);box-shadow:0 0 6px var(--aglow)}
.slider-val{font-family:var(--mono);font-size:12px;color:var(--accent);min-width:38px;text-align:right}

/* ‚îÄ‚îÄ BTN SCAN ‚îÄ‚îÄ */
.btn-scan{width:100%;padding:13px;background:transparent;border:1px solid var(--accent);border-radius:4px;color:var(--accent);font-family:var(--mono);font-size:12px;letter-spacing:2px;text-transform:uppercase;transition:all .25s;position:relative;overflow:hidden}
.btn-scan::before{content:'';position:absolute;inset:0;background:var(--accent);transform:scaleX(0);transform-origin:left;transition:transform .3s ease;z-index:-1}
.btn-scan:hover::before{transform:scaleX(1)}
.btn-scan:hover{color:#fff;box-shadow:0 0 16px var(--aglow)}
.btn-scan:disabled{opacity:.35}

/* ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ */
.status-bar{display:none;flex-direction:column;gap:12px;margin-top:18px;padding:14px 18px;background:#0a0a0a;border:1px solid var(--border);border-radius:4px}
.status-bar.visible{display:flex}
.status-info{display:flex;justify-content:space-between;align-items:center;font-family:var(--mono);font-size:12px}
.status-target{color:var(--accent);font-weight:bold}
.status-counts{display:flex;gap:16px;color:var(--muted)}
.status-counts .open{color:var(--green)}
.progress-track{height:2px;background:var(--border);border-radius:2px;overflow:hidden}
.progress-fill{height:100%;background:var(--accent);border-radius:2px;width:0%;transition:width .3s ease;box-shadow:0 0 6px var(--aglow)}

/* ‚îÄ‚îÄ SUMMARY ‚îÄ‚îÄ */
.summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--border)}
.summary-card{background:var(--card);padding:20px;text-align:center}
.summary-card .val{font-family:var(--sans);font-weight:700;font-size:2rem;line-height:1;margin-bottom:5px}
.summary-card .lbl{font-family:var(--mono);font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim)}
.val-open{color:var(--green)}.val-closed{color:var(--red)}.val-filtered{color:var(--yellow)}.val-total{color:var(--accent)}

/* ‚îÄ‚îÄ RESULTS ‚îÄ‚îÄ */
#results-panel{display:none}
#results-panel.visible{display:block}
.results-header-row{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:1px solid var(--border);gap:10px;flex-wrap:wrap}
.results-title{display:flex;align-items:center;gap:8px;font-family:var(--mono);font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted)}
.rdot{display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--green);box-shadow:0 0 5px var(--green);flex-shrink:0}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.15}}
.dot-blink{animation:blink .9s ease-in-out infinite}
.export-btns{display:flex;gap:8px;flex-wrap:wrap}
.btn-export{padding:6px 13px;background:transparent;border:1px solid var(--bm);border-radius:4px;color:var(--muted);font-family:var(--mono);font-size:11px;transition:all .2s;display:flex;align-items:center;gap:5px}
.btn-export:hover{border-color:var(--accent);color:var(--accent);background:var(--adim)}
.filter-tabs{display:flex;gap:4px;padding:10px 20px;border-bottom:1px solid var(--border);background:#080808}
.filter-tab{padding:5px 12px;border-radius:3px;border:1px solid transparent;font-family:var(--mono);font-size:11px;background:transparent;color:var(--muted);transition:all .15s}
.filter-tab:hover{color:var(--text);border-color:var(--border)}
.filter-tab.active{background:var(--adim);border-color:var(--accent);color:var(--accent)}
.table-wrap{overflow-x:auto;max-height:460px;overflow-y:auto}
table{width:100%;border-collapse:collapse}
thead tr{background:#080808;position:sticky;top:0;z-index:2}
thead th{padding:10px 20px;text-align:left;font-family:var(--mono);font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);border-bottom:1px solid var(--border);white-space:nowrap;font-weight:normal}
tbody tr{border-bottom:1px solid rgba(34,34,34,.6);transition:background .1s;animation:rowIn .2s ease both}
tbody tr:hover{background:#111}
@keyframes rowIn{from{opacity:0;transform:translateX(-5px)}to{opacity:1;transform:translateX(0)}}
tbody td{padding:10px 20px;font-family:var(--mono);font-size:12px;white-space:nowrap}
.port-num{color:var(--text);font-size:13px}
.badge{display:inline-flex;align-items:center;gap:5px;padding:2px 9px;border-radius:3px;font-size:10px;letter-spacing:.5px;text-transform:uppercase}
.badge::before{content:'';width:5px;height:5px;border-radius:50%;flex-shrink:0}
.badge-open{background:var(--gdim);color:var(--green);border:1px solid rgba(0,255,136,.15)}
.badge-open::before{background:var(--green);box-shadow:0 0 4px var(--green)}
.badge-closed{background:var(--rdim);color:var(--red);border:1px solid rgba(255,68,68,.15)}
.badge-closed::before{background:var(--red)}
.badge-filtered{background:var(--ydim);color:var(--yellow);border:1px solid rgba(255,170,0,.15)}
.badge-filtered::before{background:var(--yellow)}
.service-name{color:var(--muted)}
.risk{display:inline-block;padding:2px 8px;border-radius:3px;font-size:10px;letter-spacing:.5px;font-family:var(--mono)}
.risk-high{background:rgba(255,0,51,.12);color:#ff0033;border:1px solid rgba(255,0,51,.25)}
.risk-medium{background:rgba(255,170,0,.1);color:#ffaa00;border:1px solid rgba(255,170,0,.2)}
.risk-low{background:rgba(0,255,136,.08);color:#00ff88;border:1px solid rgba(0,255,136,.15)}
.risk-info{background:rgba(255,255,255,.03);color:#444;border:1px solid #1e1e1e}
.resp-time{color:var(--dim);font-size:11px}
.resp-time.fast{color:var(--green)}.resp-time.medium{color:var(--yellow)}.resp-time.slow{color:var(--red)}
.empty-state{text-align:center;padding:48px 24px;color:var(--dim);font-family:var(--mono);font-size:12px;line-height:2}

/* ‚îÄ‚îÄ HISTORIAL ‚îÄ‚îÄ */
.history-item{border-bottom:1px solid rgba(34,34,34,.5);font-family:var(--mono);font-size:12px}
.history-item:last-child{border-bottom:none}
.history-row{display:flex;align-items:center;justify-content:space-between;padding:11px 20px;transition:background .1s}
.history-row:hover{background:#111}
.history-target{color:var(--accent)}
.history-meta{color:var(--dim);font-size:11px;margin-left:8px}
.history-open{color:var(--green);font-size:11px;margin-left:12px}
.history-actions{display:flex;align-items:center;gap:8px}
.btn-reload,.btn-expand{padding:3px 10px;background:transparent;border:1px solid var(--bm);border-radius:3px;color:var(--muted);font-family:var(--mono);font-size:10px;transition:all .15s}
.btn-reload:hover{border-color:var(--accent);color:var(--accent)}
.btn-expand:hover{border-color:#555;color:var(--text)}
.btn-expand.active{border-color:var(--accent);color:var(--accent);background:var(--adim)}
.history-detail{max-height:0;overflow:hidden;transition:max-height .35s ease-out;background:#080808;border-top:1px solid rgba(34,34,34,.4)}
.history-detail.open{max-height:500px;transition:max-height .4s ease-in}
.history-detail-inner{padding:14px 20px}
.hd-meta{display:flex;gap:20px;flex-wrap:wrap;margin-bottom:12px}
.hd-meta span{font-size:11px;color:var(--dim)}
.hd-meta strong{color:var(--muted)}
.hd-label{font-family:var(--mono);font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--dim);margin-bottom:8px}
.hd-ports{display:flex;flex-wrap:wrap;gap:6px}
.hd-port-tag{padding:3px 10px;border-radius:3px;font-size:11px;background:var(--gdim);color:var(--green);border:1px solid rgba(0,255,136,.15)}
.hd-empty{color:var(--dim);font-size:11px;padding:4px 0}

/* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
footer{text-align:center;padding:20px;border-top:1px solid var(--border);font-family:var(--mono);font-size:11px;color:var(--dim);line-height:1.8}
footer a{color:var(--dim);text-decoration:none}
footer a:hover{color:var(--accent)}

@media(max-width:680px){.form-grid{grid-template-columns:1fr}.summary-grid{grid-template-columns:repeat(2,1fr)}.page-title h1{font-size:1.6rem}main{padding:90px 4% 50px}}
    </style>
</head>
<body class="es">

<!-- POPUP LEGAL -->
<div id="legal-overlay">
    <div class="legal-popup">
        <div class="legal-popup-title">
            <span class="es">‚ö† AVISO LEGAL</span>
            <span class="en">‚ö† LEGAL NOTICE</span>
        </div>
        <p class="es">Esta herramienta est√° dise√±ada <strong>exclusivamente para uso educativo</strong> y para el an√°lisis de redes y sistemas sobre los que tienes <strong>autorizaci√≥n expresa</strong>.</p>
        <p class="en">This tool is designed <strong>exclusively for educational use</strong> and for the analysis of networks and systems you have <strong>explicit authorization</strong> to scan.</p>
        <p class="es">El escaneo de sistemas ajenos sin permiso puede constituir un <strong>delito penal</strong> en tu jurisdicci√≥n. El autor no se responsabiliza del uso indebido de este software.</p>
        <p class="en">Scanning systems without permission may constitute a <strong>criminal offense</strong> in your jurisdiction. The author takes no responsibility for misuse of this software.</p>
        <div class="legal-popup-actions">
            <button class="btn-accept" id="btn-accept"><span class="es">Entendido</span><span class="en">Understood</span></button>
        </div>
    </div>
</div>

<!-- HEADER ‚Äî solo bot√≥n idioma -->
<header>
    <button class="lang-switch" id="lang-btn">üåê <span id="lang-label">EN</span></button>
</header>

<main>
    <div class="page-title">
        <h1>Lukita<span>Port</span></h1>
        <p class="es">ESC√ÅNER DE PUERTOS ¬∑ USO EDUCATIVO</p>
        <p class="en">PORT SCANNER ¬∑ EDUCATIONAL USE ONLY</p>
    </div>

    <!-- Configuraci√≥n -->
    <div class="panel">
        <div class="panel-header">
            <span class="dot"></span>
            <span class="es">Configuraci√≥n del escaneo</span>
            <span class="en">Scan Configuration</span>
        </div>
        <div class="panel-body">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label><span class="es">Objetivo ‚Äî IP o Dominio</span><span class="en">Target ‚Äî IP or Domain</span></label>
                    <input type="text" id="target" placeholder="192.168.1.1 ¬∑ 10.0.0.1 ¬∑ ejemplo.com" autocomplete="off" spellcheck="false"/>
                </div>
                <div class="form-group">
                    <label><span class="es">Modo de escaneo</span><span class="en">Scan Mode</span></label>
                    <select id="scan-mode">
                        <option value="quick"  data-es="R√°pido ‚Äî Puertos comunes (30)"  data-en="Quick ‚Äî Common ports (30)">R√°pido ‚Äî Puertos comunes (30)</option>
                        <option value="custom" data-es="Personalizado ‚Äî Rango definido" data-en="Custom ‚Äî Defined range">Personalizado ‚Äî Rango definido</option>
                        <option value="full"   data-es="Completo ‚Äî 1-65535 (lento)"     data-en="Full ‚Äî 1-65535 (slow)">Completo ‚Äî 1-65535 (lento)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><span class="es">Timeout por puerto</span><span class="en">Timeout per port</span></label>
                    <div class="slider-row">
                        <input type="range" id="timeout" min="0.1" max="5" step="0.1" value="1.0"/>
                        <span class="slider-val" id="timeout-val">1.0s</span>
                    </div>
                </div>
                <div class="form-group full-width">
                    <div class="custom-range" id="custom-range">
                        <div class="form-group"><label><span class="es">Puerto inicio</span><span class="en">Start port</span></label><input type="number" id="port-start" value="1" min="1" max="65535"/></div>
                        <div class="form-group"><label><span class="es">Puerto fin</span><span class="en">End port</span></label><input type="number" id="port-end" value="1024" min="1" max="65535"/></div>
                    </div>
                </div>
            </div>
            <button class="btn-scan" id="btn-scan">
                <span class="es">Iniciar Escaneo</span>
                <span class="en">Start Scan</span>
            </button>
            <div class="status-bar" id="status-bar">
                <div class="status-info">
                    <span class="status-target" id="status-target">‚Äî</span>
                    <div class="status-counts">
                        <span><span class="es">Escaneados</span><span class="en">Scanned</span>: <strong id="st-scanned">0</strong></span>
                        <span class="open"><span class="es">Abiertos</span><span class="en">Open</span>: <strong id="st-open">0</strong></span>
                        <span>Total: <strong id="st-total">0</strong></span>
                    </div>
                </div>
                <div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>
            </div>
        </div>
    </div>

    <!-- Historial -->
    <div class="panel" id="history-panel" style="display:none;">
        <div class="panel-header">
            <span class="dot" style="background:#ffaa00;box-shadow:0 0 6px rgba(255,170,0,.4)"></span>
            <span class="es">Historial reciente</span><span class="en">Recent history</span>
        </div>
        <div id="history-list"></div>
    </div>

    <!-- Summary -->
    <div class="panel" id="summary-panel" style="display:none;">
        <div class="summary-grid">
            <div class="summary-card"><div class="val val-open" id="sum-open">0</div><div class="lbl"><span class="es">Abiertos</span><span class="en">Open</span></div></div>
            <div class="summary-card"><div class="val val-closed" id="sum-closed">0</div><div class="lbl"><span class="es">Cerrados</span><span class="en">Closed</span></div></div>
            <div class="summary-card"><div class="val val-filtered" id="sum-filtered">0</div><div class="lbl"><span class="es">Filtrados</span><span class="en">Filtered</span></div></div>
            <div class="summary-card"><div class="val val-total" id="sum-total">0</div><div class="lbl"><span class="es">Escaneados</span><span class="en">Scanned</span></div></div>
        </div>
    </div>

    <!-- Resultados -->
    <div class="panel" id="results-panel">
        <div class="results-header-row">
            <div class="results-title">
                <span class="rdot" id="results-dot"></span>
                <span class="es">Resultados</span><span class="en">Results</span>
            </div>
            <div class="export-btns">
                <button class="btn-export" id="btn-json">‚Üì JSON</button>
                <button class="btn-export" id="btn-csv">‚Üì CSV</button>
                <button class="btn-export" id="btn-html">‚Üì <span class="es">Informe HTML</span><span class="en">HTML Report</span></button>
            </div>
        </div>
        <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all"><span class="es">Todos</span><span class="en">All</span></button>
            <button class="filter-tab" data-filter="open"><span class="es">Abiertos</span><span class="en">Open</span></button>
            <button class="filter-tab" data-filter="closed"><span class="es">Cerrados</span><span class="en">Closed</span></button>
            <button class="filter-tab" data-filter="filtered"><span class="es">Filtrados</span><span class="en">Filtered</span></button>
        </div>
        <div class="table-wrap">
            <table>
                <thead><tr>
                    <th><span class="es">Puerto</span><span class="en">Port</span></th>
                    <th><span class="es">Estado</span><span class="en">State</span></th>
                    <th><span class="es">Servicio</span><span class="en">Service</span></th>
                    <th><span class="es">Riesgo</span><span class="en">Risk</span></th>
                    <th><span class="es">Tiempo</span><span class="en">Time</span></th>
                </tr></thead>
                <tbody id="results-body">
                    <tr><td colspan="5"><div class="empty-state">[ _ ]<br><span class="es">Configura un objetivo y lanza el escaneo</span><span class="en">Set a target and start the scan</span></div></td></tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<footer>
    <div>LukitaPort ‚Äî <span class="es">Herramienta educativa de an√°lisis de redes</span><span class="en">Educational network analysis tool</span></div>
    <div>FastAPI + Python Sockets ¬∑ <a href="https://github.com/jaimefg1888" target="_blank">jaimefg1888</a></div>
</footer>

<script>
const PORT_RISK={21:'high',23:'high',25:'high',110:'high',139:'high',445:'high',1433:'high',1521:'high',3306:'high',3389:'high',5432:'high',5900:'high',6379:'high',27017:'high',22:'medium',53:'medium',111:'medium',135:'medium',143:'medium',8080:'medium',8888:'medium',9200:'medium',80:'low',443:'low',465:'low',587:'low',993:'low',995:'low',8443:'low'};
const RISK_LABELS={es:{high:'Alto riesgo',medium:'Riesgo medio',low:'Bajo riesgo',info:'Sin datos'},en:{high:'High risk',medium:'Medium risk',low:'Low risk',info:'No data'}};
const getRisk=p=>PORT_RISK[p]||'info';

const state={results:[],scanMeta:null,scanning:false,filter:'all',counts:{open:0,closed:0,filtered:0},eventSource:null,lang:'es'};
const $=id=>document.getElementById(id);

// Popup
const overlay=$('legal-overlay');
if(localStorage.getItem('lukita_legal_ok')==='1')overlay.classList.add('hidden');
$('btn-accept').addEventListener('click',()=>{overlay.classList.add('hidden');localStorage.setItem('lukita_legal_ok','1');});

// Idioma
function applyLang(lang){
    state.lang=lang;document.body.className=lang;$('lang-label').textContent=lang==='es'?'EN':'ES';
    Array.from($('scan-mode').options).forEach(o=>{o.textContent=o.dataset[lang];});
    if(state.results.length)renderTable();
    renderHistory();
}
$('lang-btn').addEventListener('click',()=>{
    applyLang(state.lang==='es'?'en':'es');
    $('lang-btn').classList.remove('pulse');void $('lang-btn').offsetWidth;$('lang-btn').classList.add('pulse');
    $('lang-btn').addEventListener('animationend',()=>$('lang-btn').classList.remove('pulse'),{once:true});
});

// Limpiar URL
function cleanTarget(raw){
    let t=raw.trim().replace(/^https?:\/\//i,'').split('/')[0].split('?')[0].split('#')[0];
    const isIP=/^\d{1,3}(\.\d{1,3}){3}$/.test(t.split(':')[0]);
    if(!isIP)t=t.split(':')[0];
    return t.trim();
}
$('target').addEventListener('input',function(){this.style.borderColor=/^https?:\/\//i.test(this.value)?'#ffaa00':'';});

// historial en memoria ‚Äî se limpia al cerrar/refrescar
let _sessionHistory=[];
const loadHistory=()=>_sessionHistory;
function saveHistory(e){
    if(_sessionHistory.length&&_sessionHistory[0].target===e.target){_sessionHistory[0]=e;}else{_sessionHistory.unshift(e);if(_sessionHistory.length>5)_sessionHistory=_sessionHistory.slice(0,5);}
}
function renderHistory(){
    const h=loadHistory();const panel=$('history-panel');const list=$('history-list');
    if(!h.length){panel.style.display='none';return;}
    panel.style.display='block';
    list.innerHTML=h.map((item,idx)=>{
        const openPorts=item.openPorts||[];
        const riskHigh=item.riskHigh||0;const riskMed=item.riskMed||0;
        const tagsHtml=openPorts.length
            ?openPorts.map(p=>'<span class="hd-port-tag">'+p.port+' <span style="opacity:.6;font-size:10px">'+p.service+'</span></span>').join('')
            :'<span class="hd-empty">'+(state.lang==='es'?'Sin puertos abiertos':'No open ports')+'</span>';
        const riskLine=riskHigh?'<span style="color:#ff0033">‚¨§ '+riskHigh+' '+(state.lang==='es'?'alto riesgo':'high risk')+'</span>':'';
        const medLine=riskMed?'<span style="color:#ffaa00">‚¨§ '+riskMed+' '+(state.lang==='es'?'medio riesgo':'medium risk')+'</span>':'';
        return`<div class="history-item" id="hi-${idx}">
            <div class="history-row">
                <div><span class="history-target">${item.target}</span><span class="history-meta">‚Äî ${item.date}</span></div>
                <div class="history-actions">
                    <span class="history-open">‚óè ${item.open} <span class="es">abiertos</span><span class="en">open</span></span>
                    <button class="btn-expand" data-idx="${idx}">‚äû <span class="es">Ver</span><span class="en">View</span></button>
                    <button class="btn-reload" data-idx="${idx}">‚Ü∫ <span class="es">Relanzar</span><span class="en">Retry</span></button>
                </div>
            </div>
            <div class="history-detail" id="hd-${idx}">
                <div class="history-detail-inner">
                    <div class="hd-meta">
                        <span><strong>IP:</strong> ${item.ip||'‚Äî'}</span>
                        <span><strong>${state.lang==='es'?'Modo':'Mode'}:</strong> ${item.mode||'‚Äî'}</span>
                        <span><strong>${state.lang==='es'?'Escaneados':'Scanned'}:</strong> ${item.total||'?'}</span>
                        ${riskLine}${medLine}
                    </div>
                    <div class="hd-label">${state.lang==='es'?'Puertos abiertos':'Open ports'}</div>
                    <div class="hd-ports">${tagsHtml}</div>
                </div>
            </div>
        </div>`;
    }).join('');
    list.querySelectorAll('.btn-expand').forEach(btn=>{
        btn.addEventListener('click',()=>{
            const detail=$('hd-'+btn.dataset.idx);const isOpen=detail.classList.contains('open');
            list.querySelectorAll('.history-detail').forEach(d=>d.classList.remove('open'));
            list.querySelectorAll('.btn-expand').forEach(b=>b.classList.remove('active'));
            if(!isOpen){detail.classList.add('open');btn.classList.add('active');}
        });
    });
    list.querySelectorAll('.btn-reload').forEach(btn=>{
        btn.addEventListener('click',()=>{$('target').value=loadHistory()[+btn.dataset.idx].target;startScan();});
    });
}

// Form
$('scan-mode').addEventListener('change',()=>{$('custom-range').classList.toggle('visible',$('scan-mode').value==='custom');});
$('timeout').addEventListener('input',()=>{$('timeout-val').textContent=parseFloat($('timeout').value).toFixed(1)+'s';});
document.querySelectorAll('.filter-tab').forEach(tab=>{
    tab.addEventListener('click',()=>{document.querySelectorAll('.filter-tab').forEach(t=>t.classList.remove('active'));tab.classList.add('active');state.filter=tab.dataset.filter;renderTable();});
});
$('btn-json').addEventListener('click',exportJSON);
$('btn-csv').addEventListener('click',exportCSV);
$('btn-html').addEventListener('click',exportHTMLReport);
$('target').addEventListener('keydown',e=>{if(e.key==='Enter'&&!state.scanning)startScan();});
$('btn-scan').addEventListener('click',()=>{state.scanning?stopScan():startScan();});

function setDotBlink(on){on?$('results-dot').classList.add('dot-blink'):$('results-dot').classList.remove('dot-blink');}

function startScan(){
    const target=cleanTarget($('target').value);
    if(!target){$('target').focus();return;}
    $('target').value=target;$('target').style.borderColor='';
    state.results=[];state.counts={open:0,closed:0,filtered:0};state.scanMeta=null;state.scanning=true;
    $('btn-scan').querySelector('.es').textContent='Detener';
    $('btn-scan').querySelector('.en').textContent='Stop';
    $('btn-scan').style.borderColor='#ff4444';$('btn-scan').style.color='#ff4444';
    $('results-body').innerHTML='';
    $('status-bar').classList.add('visible');
    $('results-panel').classList.add('visible');
    $('summary-panel').style.display='none';
    setDotBlink(true);updateSummary();

    const params=new URLSearchParams({target,mode:$('scan-mode').value,port_start:$('port-start').value,port_end:$('port-end').value,timeout:$('timeout').value});
    if(state.eventSource)state.eventSource.close();

    // Intentar backend real en localhost:8000, si falla usar simulaci√≥n
    const API_BASE = 'http://localhost:8000';
    let backendOk = false;
    state.eventSource = new EventSource(API_BASE + '/api/scan?' + params);

    state.eventSource.onmessage = e => {
        backendOk = true;
        const d = JSON.parse(e.data);
        if(d.error){showError(d.error);stopScan();return;}
        if(d.type==='meta'){
            state.scanMeta=d;
            $('status-target').textContent=(d.hostname&&d.hostname!==d.ip)?d.hostname+' ('+d.ip+')':d.ip;
            $('st-total').textContent=d.total_ports;return;
        }
        if(d.type==='port'){
            state.results.push(d);state.counts[d.state]++;
            $('st-scanned').textContent=d.scanned;$('st-open').textContent=state.counts.open;
            $('progress-fill').style.width=d.progress+'%';
            if(state.filter==='all'||state.filter===d.state)appendRow(d);
            updateSummary();return;
        }
        if(d.type==='done')stopScan(true);
    };
    state.eventSource.onerror = () => {
        if(!backendOk && state.scanning){
            state.eventSource.close(); state.eventSource = null;
            runSimulation(target);
        } else if(state.scanning){
            stopScan();
        }
    };
}

// simulaci√≥n ‚Äî se activa si no hay backend disponible
const SERVICES={21:'FTP',22:'SSH',23:'Telnet',25:'SMTP',53:'DNS',80:'HTTP',110:'POP3',111:'RPC',135:'MSRPC',139:'NetBIOS',143:'IMAP',443:'HTTPS',445:'SMB',465:'SMTPS',587:'SMTP/TLS',993:'IMAPS',995:'POP3S',1433:'MSSQL',1521:'Oracle DB',3306:'MySQL',3389:'RDP',5432:'PostgreSQL',5900:'VNC',6379:'Redis',8080:'HTTP-Alt',8443:'HTTPS-Alt',8888:'HTTP-Dev',9200:'Elasticsearch',27017:'MongoDB'};
const COMMON_PORTS_SIM=[21,22,23,25,53,80,110,111,135,139,143,443,445,465,587,993,995,1433,1521,1723,3306,3389,5432,5900,6379,8080,8443,8888,9200,27017];

function runSimulation(target){
    const mode=$('scan-mode').value;
    let ports=[];
    if(mode==='quick'){ports=[...COMMON_PORTS_SIM];}
    else{const ps=parseInt($('port-start').value)||1;const pe=parseInt($('port-end').value)||(mode==='full'?65535:1024);for(let p=ps;p<=pe&&ports.length<500;p++)ports.push(p);}
    const total=ports.length;
    state.scanMeta={input:target,ip:target,hostname:target,mode,total_ports:total};
    $('status-target').textContent=target+' (sin backend)';
    $('st-total').textContent=total;

    const openSet=new Set();
    const cands=ports.filter(p=>SERVICES[p]).sort(()=>Math.random()-.5);
    cands.slice(0,Math.min(Math.floor(Math.random()*5)+2,cands.length)).forEach(p=>openSet.add(p));

    let idx=0;
    const BATCH=mode==='full'?10:1;
    const DELAY=mode==='full'?15:mode==='quick'?70:25;

    function step(){
        if(!state.scanning)return;
        for(let b=0;b<BATCH&&idx<total;b++,idx++){
            const port=ports[idx];
            const st=openSet.has(port)?'open':Math.random()<0.07?'filtered':'closed';
            const ms=st==='open'?Math.floor(Math.random()*120)+8:null;
            const d={port,state:st,service:SERVICES[port]||'Unknown',response_time_ms:ms,scanned:idx+1,progress:Math.round(((idx+1)/total)*100)};
            state.results.push(d);state.counts[d.state]++;
            $('st-scanned').textContent=d.scanned;$('st-open').textContent=state.counts.open;
            $('progress-fill').style.width=d.progress+'%';
            if(state.filter==='all'||state.filter===d.state)appendRow(d);
            updateSummary();
        }
        if(idx<total&&state.scanning)setTimeout(step,DELAY);
        else if(state.scanning)stopScan(true);
    }
    setTimeout(step,DELAY);
}

function stopScan(completed=false){
    state.scanning=false;
    if(state.eventSource){state.eventSource.close();state.eventSource=null;}
    $('btn-scan').querySelector('.es').textContent='Iniciar Escaneo';
    $('btn-scan').querySelector('.en').textContent='Start Scan';
    $('btn-scan').style.borderColor='';$('btn-scan').style.color='';
    setDotBlink(false);
    if(completed){
        $('progress-fill').style.width='100%';
        $('summary-panel').style.display='block';
        if(state.scanMeta){
            const openPorts=state.results.filter(r=>r.state==='open').map(r=>({port:r.port,service:r.service}));
            saveHistory({target:state.scanMeta.input||state.scanMeta.ip,ip:state.scanMeta.ip,mode:state.scanMeta.mode,open:state.counts.open,total:state.results.length,riskHigh:openPorts.filter(p=>getRisk(p.port)==='high').length,riskMed:openPorts.filter(p=>getRisk(p.port)==='medium').length,openPorts,date:new Date().toLocaleString()});
            renderHistory();
        }
    }
    if(!state.results.length){const msg=state.lang==='es'?'Sin resultados':'No results found';$('results-body').innerHTML='<tr><td colspan="5"><div class="empty-state">[ _ ]<br>'+msg+'</div></td></tr>';}
}

function appendRow(d){
    const tr=document.createElement('tr');tr.dataset.state=d.state;
    const risk=getRisk(d.port);const rl=RISK_LABELS[state.lang][risk];
    const riskCell=d.state==='open'?'<span class="risk risk-'+risk+'">'+rl+'</span>':'<span style="color:#333">‚Äî</span>';
    tr.innerHTML='<td class="port-num">'+d.port+'</td><td><span class="badge badge-'+d.state+'">'+translateState(d.state)+'</span></td><td class="service-name">'+d.service+'</td><td>'+riskCell+'</td><td class="resp-time '+getRespClass(d.response_time_ms)+'">'+(d.response_time_ms!==null?d.response_time_ms+' ms':'‚Äî')+'</td>';
    $('results-body').appendChild(tr);
    const w=$('results-body').closest('.table-wrap');
    if(w.scrollTop+w.clientHeight>=w.scrollHeight-80)w.scrollTop=w.scrollHeight;
}

function renderTable(){
    $('results-body').innerHTML='';
    const f=state.filter==='all'?state.results:state.results.filter(r=>r.state===state.filter);
    if(!f.length){const msg=state.lang==='es'?'Sin resultados para este filtro':'No results for this filter';$('results-body').innerHTML='<tr><td colspan="5"><div class="empty-state">[ _ ]<br>'+msg+'</div></td></tr>';return;}
    f.forEach(appendRow);
}

function updateSummary(){$('sum-open').textContent=state.counts.open;$('sum-closed').textContent=state.counts.closed;$('sum-filtered').textContent=state.counts.filtered;$('sum-total').textContent=state.results.length;}
function translateState(s){return(state.lang==='en'?{open:'Open',closed:'Closed',filtered:'Filtered'}:{open:'Abierto',closed:'Cerrado',filtered:'Filtrado'})[s]||s;}
function getRespClass(ms){if(ms===null)return'';if(ms<100)return'fast';if(ms<500)return'medium';return'slow';}
function showError(msg){$('results-body').innerHTML='<tr><td colspan="5"><div class="empty-state" style="color:#ff0033">‚úï<br>'+msg+'</div></td></tr>';}
function getTs(){return new Date().toISOString().replace(/[:.]/g,'-').slice(0,19);}
function getSlug(){return(state.scanMeta?.ip??'scan').replace(/\./g,'_');}

function exportJSON(){
    if(!state.results.length)return;
    const p={meta:{tool:'LukitaPort v1.0.0',author:'jaimefg1888',generated_at:new Date().toISOString(),target:state.scanMeta,summary:{...state.counts,total:state.results.length}},results:state.results.map(r=>({...r,risk:getRisk(r.port)}))};
    dl(JSON.stringify(p,null,2),'lukitaport_'+getSlug()+'_'+getTs()+'.json','application/json');
}
function exportCSV(){
    if(!state.results.length)return;
    const rows=[['Port','State','Service','Risk','Response_ms']];
    state.results.forEach(r=>rows.push([r.port,r.state,r.service,getRisk(r.port),r.response_time_ms??'']));
    dl(rows.map(r=>r.join(',')).join('\r\n'),'lukitaport_'+getSlug()+'_'+getTs()+'.csv','text/csv');
}
function exportHTMLReport(){
    if(!state.results.length)return;
    const meta=state.scanMeta||{};const ts=new Date().toLocaleString();
    const openP=state.results.filter(r=>r.state==='open');
    const highN=openP.filter(r=>getRisk(r.port)==='high').length;
    const medN=openP.filter(r=>getRisk(r.port)==='medium').length;
    const rc={high:'#ff0033',medium:'#ffaa00',low:'#00ff88',info:'#444'};
    const rl2={high:'HIGH',medium:'MEDIUM',low:'LOW',info:'‚Äî'};
    const rows=state.results.map(r=>{const sc=r.state==='open'?'#00ff88':r.state==='filtered'?'#ffaa00':'#ff4444';const rk=getRisk(r.port);return'<tr><td>'+r.port+'</td><td style="color:'+sc+'">‚óè '+r.state.charAt(0).toUpperCase()+r.state.slice(1)+'</td><td>'+r.service+'</td><td style="color:'+rc[rk]+';font-size:10px">'+rl2[rk]+'</td><td>'+(r.response_time_ms??'‚Äî')+' ms</td></tr>';}).join('');
    const html=`<!DOCTYPE html><html><head><meta charset="UTF-8"/><title>LukitaPort Report</title><style>*{margin:0;padding:0;box-sizing:border-box}body{background:#050505;color:#f0f0f0;font-family:'Fira Code',monospace;font-size:13px;padding:40px;line-height:1.6}h1{font-size:1.8rem;color:#ff0033;margin-bottom:4px}.sub{color:#555;font-size:11px;letter-spacing:1px;margin-bottom:28px}.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:#1a1a1a;margin-bottom:28px;border-radius:4px;overflow:hidden}.card{background:#0d0d0d;padding:18px;text-align:center}.card .n{font-size:2rem;font-weight:bold;line-height:1;margin-bottom:4px}.card .l{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:#333}.rs{display:flex;gap:10px;margin-bottom:24px}.rsi{padding:8px 14px;border-radius:4px;font-size:11px}.rsh{background:rgba(255,0,51,.1);border:1px solid rgba(255,0,51,.2);color:#ff0033}.rsm{background:rgba(255,170,0,.1);border:1px solid rgba(255,170,0,.2);color:#ffaa00}h2{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:#444;margin:24px 0 10px;border-bottom:1px solid #111;padding-bottom:8px}table{width:100%;border-collapse:collapse}th{text-align:left;padding:8px 14px;font-size:10px;letter-spacing:1px;text-transform:uppercase;color:#333;border-bottom:1px solid #111;font-weight:normal}td{padding:9px 14px;border-bottom:1px solid rgba(20,20,20,.9)}.mrow td:first-child{color:#444;width:160px}footer{margin-top:40px;color:#333;font-size:11px;text-align:center;border-top:1px solid #111;padding-top:18px}</style></head><body><h1>LukitaPort</h1><div class="sub">PORT SCAN REPORT ¬∑ ${ts}</div><div class="grid"><div class="card"><div class="n" style="color:#00ff88">${state.counts.open}</div><div class="l">Open</div></div><div class="card"><div class="n" style="color:#ff4444">${state.counts.closed}</div><div class="l">Closed</div></div><div class="card"><div class="n" style="color:#ffaa00">${state.counts.filtered}</div><div class="l">Filtered</div></div><div class="card"><div class="n" style="color:#ff0033">${state.results.length}</div><div class="l">Total</div></div></div><div class="rs"><div class="rsi rsh">‚¨§ HIGH RISK: <strong>${highN}</strong></div><div class="rsi rsm">‚¨§ MEDIUM RISK: <strong>${medN}</strong></div></div><h2>Scan Metadata</h2><table><tr class="mrow"><td>Target</td><td>${meta.input??'‚Äî'}</td></tr><tr class="mrow"><td>Resolved IP</td><td>${meta.ip??'‚Äî'}</td></tr><tr class="mrow"><td>Hostname</td><td>${meta.hostname??'‚Äî'}</td></tr><tr class="mrow"><td>Mode</td><td>${meta.mode??'‚Äî'}</td></tr><tr class="mrow"><td>Ports scanned</td><td>${meta.total_ports??state.results.length}</td></tr><tr class="mrow"><td>Generated</td><td>${ts}</td></tr></table><h2>All Results</h2><table><thead><tr><th>Port</th><th>State</th><th>Service</th><th>Risk</th><th>Response</th></tr></thead><tbody>${rows}</tbody></table><footer>LukitaPort v1.0.0 ¬∑ jaimefg1888 ¬∑ For educational use only</footer></body></html>`;
    dl(html,'lukitaport_report_'+getSlug()+'_'+getTs()+'.html','text/html');
}
function dl(content,name,type){const b=new Blob([content],{type});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;a.click();URL.revokeObjectURL(u);}

renderHistory();
</script>
</body>
</html>
